/**
 * One-time build script to create a CodeMirror 6 IIFE vendor bundle.
 * Run: cd scripts && npm install && node build-codemirror-vendor.mjs
 */

import * as esbuild from "esbuild";
import { writeFileSync } from "fs";
import { resolve, dirname } from "path";
import { fileURLToPath } from "url";

const __dirname = dirname(fileURLToPath(import.meta.url));
const VENDOR_DIR = resolve(__dirname, "../src/anteroom/static/vendor");

const entryCode = `
import { EditorView, keymap, lineNumbers, highlightActiveLine, highlightActiveLineGutter, drawSelection, placeholder } from "@codemirror/view";
import { EditorState } from "@codemirror/state";
import { markdown, markdownLanguage } from "@codemirror/lang-markdown";
import { defaultHighlightStyle, syntaxHighlighting, indentOnInput, bracketMatching, foldGutter } from "@codemirror/language";
import { defaultKeymap, history, historyKeymap, indentWithTab } from "@codemirror/commands";
import { searchKeymap, highlightSelectionMatches } from "@codemirror/search";
import { tags } from "@lezer/highlight";
import { HighlightStyle } from "@codemirror/language";

const appTheme = EditorView.theme({
  "&": {
    height: "100%",
    fontSize: "14px",
  },
  ".cm-scroller": {
    overflow: "auto",
    fontFamily: "var(--font-mono)",
    lineHeight: "1.6",
  },
  ".cm-content": {
    padding: "16px 20px",
    caretColor: "var(--accent)",
  },
  ".cm-cursor, .cm-dropCursor": {
    borderLeftColor: "var(--accent)",
  },
  "&.cm-focused .cm-selectionBackground, .cm-selectionBackground": {
    backgroundColor: "var(--bg-active)",
  },
  ".cm-activeLine": {
    backgroundColor: "transparent",
  },
  ".cm-activeLineGutter": {
    backgroundColor: "transparent",
  },
  ".cm-gutters": {
    backgroundColor: "var(--bg-secondary)",
    color: "var(--text-muted)",
    border: "none",
    borderRight: "1px solid var(--border-color)",
  },
  ".cm-lineNumbers .cm-gutterElement": {
    padding: "0 8px 0 12px",
    minWidth: "3ch",
  },
  ".cm-foldGutter .cm-gutterElement": {
    padding: "0 4px",
  },
  "&.cm-focused": {
    outline: "none",
  },
  ".cm-selectionMatch": {
    backgroundColor: "var(--accent-subtle)",
  },
  ".cm-searchMatch": {
    backgroundColor: "var(--accent-subtle)",
    outline: "1px solid var(--accent)",
  },
  ".cm-panels": {
    backgroundColor: "var(--bg-secondary)",
    color: "var(--text-primary)",
  },
  ".cm-panels input, .cm-panels button": {
    color: "var(--text-primary)",
  },
  ".cm-tooltip": {
    backgroundColor: "var(--bg-card)",
    border: "1px solid var(--border-color)",
    color: "var(--text-primary)",
  },
}, { dark: false });

const appHighlight = HighlightStyle.define([
  { tag: tags.heading1, fontWeight: "700", fontSize: "1.5em" },
  { tag: tags.heading2, fontWeight: "700", fontSize: "1.3em" },
  { tag: tags.heading3, fontWeight: "600", fontSize: "1.1em" },
  { tag: tags.heading4, fontWeight: "600" },
  { tag: tags.strong, fontWeight: "700" },
  { tag: tags.emphasis, fontStyle: "italic" },
  { tag: tags.strikethrough, textDecoration: "line-through" },
  { tag: tags.link, color: "var(--accent)", textDecoration: "underline" },
  { tag: tags.url, color: "var(--accent)" },
  { tag: tags.monospace, fontFamily: "var(--font-mono)", fontSize: "0.9em" },
  { tag: tags.quote, color: "var(--text-secondary)", fontStyle: "italic" },
  { tag: tags.meta, color: "var(--text-muted)" },
  { tag: tags.comment, color: "var(--text-muted)" },
  { tag: tags.processingInstruction, color: "var(--text-muted)" },
]);

window.CM = {
  EditorView,
  EditorState,
  markdown,
  markdownLanguage,
  keymap,
  lineNumbers,
  highlightActiveLine,
  highlightActiveLineGutter,
  drawSelection,
  placeholder,
  defaultKeymap,
  history,
  historyKeymap,
  indentWithTab,
  searchKeymap,
  highlightSelectionMatches,
  syntaxHighlighting,
  defaultHighlightStyle,
  indentOnInput,
  bracketMatching,
  foldGutter,
  appTheme,
  appHighlight,
};
`;

const tmpEntry = resolve(__dirname, "_cm_entry.mjs");
writeFileSync(tmpEntry, entryCode);

try {
  await esbuild.build({
    entryPoints: [tmpEntry],
    bundle: true,
    minify: true,
    format: "iife",
    target: ["es2020"],
    outfile: resolve(VENDOR_DIR, "codemirror-bundle.min.js"),
  });

  // Extract CSS from a second build pass
  await esbuild.build({
    entryPoints: [tmpEntry],
    bundle: true,
    minify: true,
    format: "iife",
    target: ["es2020"],
    outfile: resolve(__dirname, "_cm_css_temp.js"),
    write: false,
  });

  // CodeMirror's CSS comes from the theme extension at runtime, not from a CSS file.
  // We generate a minimal CSS file for base editor resets.
  const baseCss = `/* CodeMirror 6 base styles - generated by build-codemirror-vendor.mjs */
.cm-editor { height: 100%; }
.cm-editor .cm-scroller { overflow: auto; }
.cm-editor .cm-content { white-space: pre-wrap; word-break: break-word; }
.cm-editor.cm-focused { outline: none; }
`;
  writeFileSync(resolve(VENDOR_DIR, "codemirror-bundle.min.css"), baseCss);

  console.log("Built codemirror-bundle.min.js and codemirror-bundle.min.css");
} finally {
  const { unlinkSync } = await import("fs");
  try { unlinkSync(tmpEntry); } catch {}
  try { unlinkSync(resolve(__dirname, "_cm_css_temp.js")); } catch {}
}
